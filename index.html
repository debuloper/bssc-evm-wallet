<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>bssc-evm-wallet — single HTML (raw RPC, no batching)</title>
<style>
  :root{--bg:#0b0b10;--card:#10111a;--stroke:rgba(255,255,255,.08);--fg:#e5e7eb;--mut:#9ca3af;--pri:#6d28d9;--pri2:#4f46e5}
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
  .shell{max-width:920px;margin:0 auto;padding:24px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .card{background:linear-gradient(180deg,#10111a,#0b0b10 65%);border:1px solid var(--stroke);border-radius:14px;padding:16px;margin-top:12px}
  .btn{background-image:linear-gradient(135deg,var(--pri),var(--pri2));color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.ghost{background:#ffffff14;border:1px solid #ffffff22;color:#fff}
  .mut{color:var(--mut)} .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,Consolas,Menlo,monospace}
  .field{flex:1;min-width:180px;background:#0f1117;color:#fff;border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;outline:none}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .log{background:#0f1117;border:1px solid var(--stroke);border-radius:12px;padding:10px;margin-top:8px;white-space:pre-wrap;word-break:break-word}
  .link{color:#c7d2fe;text-decoration:none} .link:hover{text-decoration:underline}
  .hint{font-size:12px;color:#9ca3af}
  .right{margin-left:auto}
</style>
</head>
<body>
<main class="shell">
  <h1 style="margin:0 0 6px 0">bssc-evm-wallet <span class="mut">(single html / raw JSON-RPC / no MetaMask)</span></h1>
  <div class="mut" style="margin-bottom:12px">ブラウザ内で鍵生成→ローカル署名→<b>自前JSON-RPC</b>で送信（バッチ＆並列なし）。</div>

  <div class="card">
    <div class="row">
      <div class="mut">RPC</div>
      <input id="rpc" class="field" value="https://bssc-rpc.bssc.live" />
      <button id="btnUseRpc" class="btn">Use RPC</button>
      <span class="hint">（通らない場合は別RPCに差し替え）</span>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnPing" class="btn ghost">Ping (blockNumber)</button>
      <button id="btnGas"  class="btn ghost">Gas (gwei)</button>
      <button id="btnRefresh" class="btn ghost">Refresh Balance</button>
      <span class="right mut">Explorer: <a id="expl" target="_blank" rel="noreferrer" class="link" href="https://explorer.bssc.live">explorer.bssc.live</a></span>
    </div>
    <div id="netlog" class="log" style="display:none"></div>
  </div>

  <div class="card">
    <div class="row">
      <button id="btnGen" class="btn">Generate Wallet</button>
      <button id="btnRecover" class="btn ghost">Recover (0x private key)</button>
      <button id="btnCopyPK" class="btn ghost">Copy PK</button>
    </div>
    <div class="grid" style="margin-top:12px">
      <div>
        <div class="mut">Address</div>
        <div id="addr" class="mono">—</div>
      </div>
      <div>
        <div class="mut">Balance</div>
        <div id="bal" class="mono">—</div>
      </div>
    </div>
    <div style="margin-top:10px">
      <div class="mut">Private Key (hex 0x…)</div>
      <textarea id="pk" class="field" rows="2" placeholder="0x..."></textarea>
      <div class="hint" style="margin-top:6px">※ デモ用途：本番はIndexedDB＋PIN/AESで暗号保存にしてください。</div>
    </div>
  </div>

  <div class="card">
    <div class="mut" style="margin-bottom:6px">Send BNB</div>
    <div class="row">
      <input id="to" class="field" placeholder="Recipient (0x...)"/>
      <input id="amt" class="field" placeholder="Amount (BNB)"/>
      <button id="btnMax" class="btn ghost">Max</button>
      <button id="btnSend" class="btn">Send</button>
    </div>
    <div id="tx" class="log" style="display:none"></div>
  </div>

  <p class="mut" style="margin-top:16px;font-size:13px">
    ※ この実装は <b>常に1回のJSON-RPCだけ</b>を順番に送ります（バッチ禁止・並列禁止）。<br/>
    ※ 受け取りは相手があなたのアドレス（0x…）にBSSCネットワークで送るだけ。
  </p>
</main>

<script type="module">
import { Wallet, formatEther, Transaction } from "https://esm.sh/ethers@6.13.2?bundle";

/* ---------- DOM helpers ---------- */
const $ = (id)=>document.getElementById(id);
const log = (el, msg) => { el.style.display="block"; el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`; };

/* ---------- State ---------- */
let RPC_URL = "https://bssc-rpc.bssc.live";
let wallet  = null;
const EXPL_BASE = "https://explorer.bssc.live";

/* ---------- strict single-call JSON-RPC ---------- */
async function rpc(method, params=[]){
  const body = { jsonrpc:"2.0", id: Date.now(), method, params };
  const r = await fetch(RPC_URL, {
    method:"POST",
    headers:{ "content-type":"application/json" },
    body: JSON.stringify(body),
    cache:"no-store",
  });
  const j = await r.json().catch(()=> ({}));
  if (j?.error) throw new Error(j.error.message || "RPC error");
  if (j?.result === undefined) throw new Error("RPC missing result");
  return j.result;
}

/* ---------- utilities ---------- */
const toHex = (n)=> "0x" + n.toString(16);
function parseAmountToWei(str){
  const s = String(str || "").trim();
  if(!/^[0-9]+(\.[0-9]{0,18})?$/.test(s)) throw new Error("Invalid decimal (max 18 dp)");
  const [ints, frac=""] = s.split(".");
  const fracPadded = (frac + "0".repeat(18)).slice(0,18);
  return BigInt(ints) * 10n**18n + BigInt(fracPadded);
}

/* ---------- basic calls (all sequential) ---------- */
async function ping(){
  const hex = await rpc("eth_blockNumber", []);
  return parseInt(hex, 16);
}
async function gasPrice(){
  const hex = await rpc("eth_gasPrice", []);
  return BigInt(hex); // wei
}
async function chainId(){
  const hex = await rpc("eth_chainId", []);
  return parseInt(hex, 16);
}
async function getBalance(addr){
  const hex = await rpc("eth_getBalance", [addr, "latest"]);
  return BigInt(hex);
}
async function getNonce(addr, tag="pending"){
  const hex = await rpc("eth_getTransactionCount", [addr, tag]);
  return parseInt(hex, 16);
}
async function sendRaw(rawTx){
  return rpc("eth_sendRawTransaction", [rawTx]);
}
async function getReceipt(txHash){
  return rpc("eth_getTransactionReceipt", [txHash]);
}

/* ---------- UI actions ---------- */
$("btnUseRpc").onclick = async () => {
  try {
    RPC_URL = $("rpc").value.trim();
    const bn = await ping();
    log($("netlog"), "RPC OK (block " + bn + ")");
  } catch(e){ log($("netlog"), "RPC error: "+(e.message||e)); }
};

$("btnPing").onclick = async () => {
  try{ log($("netlog"), `Ping OK (block ${await ping()})`); }
  catch(e){ log($("netlog"), "Ping error: "+(e.message||e)); }
};

$("btnGas").onclick = async () => {
  try{
    const g = await gasPrice();
    const gwei = Number(g) / 1e9;
    log($("netlog"), `Gas price ~ ${gwei.toFixed(2)} gwei`);
  }catch(e){ log($("netlog"), "Gas error: "+(e.message||e)); }
};

$("btnGen").onclick = async () => {
  try{
    wallet = Wallet.createRandom();
    $("addr").textContent = wallet.address;
    $("pk").value = wallet.privateKey;
    const bal = await getBalance(wallet.address);
    $("bal").textContent = `${Number(formatEther(bal)).toFixed(6)} BNB`;
    log($("netlog"), "Generated new EVM wallet");
  }catch(e){ log($("netlog"), "Generate error: "+(e.message||e)); }
};

$("btnRecover").onclick = async () => {
  try{
    const raw = $("pk").value.trim();
    const pk = raw.startsWith("0x") ? raw : ("0x"+raw);
    if(!/^0x[0-9a-fA-F]{64}$/.test(pk)) throw new Error("Private key must be 32-byte hex (0x...)");
    wallet = new Wallet(pk);
    $("addr").textContent = wallet.address;
    $("pk").value = wallet.privateKey;
    const bal = await getBalance(wallet.address);
    $("bal").textContent = `${Number(formatEther(bal)).toFixed(6)} BNB`;
    log($("netlog"), "Recovered wallet");
  }catch(e){ log($("netlog"), "Recover error: "+(e.message||e)); }
};

$("btnCopyPK").onclick = async () => {
  const s = $("pk").value.trim();
  if(!s) return;
  try{ await navigator.clipboard.writeText(s); log($("netlog"), "Private key copied"); }catch{}
};

$("btnRefresh").onclick = async () => {
  try{
    if(!wallet) throw new Error("Generate/Recover first");
    const bal = await getBalance(wallet.address);
    $("bal").textContent = `${Number(formatEther(bal)).toFixed(6)} BNB`;
    log($("netlog"), "Balance refreshed");
  }catch(e){ log($("netlog"), "Balance error: "+(e.message||e)); }
};

$("btnMax").onclick = async () => {
  try{
    if(!wallet) throw new Error("Generate/Recover first");
    const balWei   = await getBalance(wallet.address);
    const gasWei   = await gasPrice();
    const gasLimit = 21000n;
    const reserve  = gasWei * gasLimit;
    const maxWei   = balWei > reserve ? (balWei - reserve) : 0n;
    const max      = Number(formatEther(maxWei));
    $("amt").value = max > 0 ? String(max) : "0";
    log($("netlog"), "Max computed");
  }catch(e){ log($("netlog"), "Max error: "+(e.message||e)); }
};

$("btnSend").onclick = async () => {
  const box = $("tx");
  try{
    if(!wallet) throw new Error("Generate/Recover first");
    const to  = $("to").value.trim();
    const amt = $("amt").value.trim();
    if(!/^0x[0-9a-fA-F]{40}$/.test(to)) throw new Error("Recipient must be 0x-address");
    if(!/^[0-9]+(\.[0-9]{0,18})?$/.test(amt)) throw new Error("Amount invalid (max 18 dp)");

    // 必要情報を「順番に」取得（並列禁止）
    const [cid, nonce, gasWei] = [
      await chainId(),
      await getNonce(wallet.address, "pending"),
      await gasPrice()
    ];

    const value = parseAmountToWei(amt);
    const txFields = {
      to,
      nonce,                   // number
      chainId: cid,            // number
      gasPrice: gasWei,        // bigint(wei)
      gasLimit: 21000n,        // bigint
      value                    // bigint
    };

    // 署名（raw tx 作成）
    const rawTx = await wallet.signTransaction(txFields);
    // 送信（自前）
    const txHash = await sendRaw(rawTx);

    const link = `${EXPL_BASE}/tx/${txHash}`;
    box.style.display="block";
    box.innerHTML = `Tx Hash:\n${txHash}\n\n<a class="link" href="${link}" target="_blank" rel="noreferrer">Open in Explorer</a>`;
    log($("netlog"), "TX sent");

    // 簡易ポーリング（receipt待ち）
    try{
      for(let i=0;i<20;i++){
        await new Promise(r=>setTimeout(r,1500));
        const r = await getReceipt(txHash);
        if(r && r.blockNumber){ log($("netlog"), `Confirmed in block ${parseInt(r.blockNumber,16)}`); break; }
      }
      const bal = await getBalance(wallet.address);
      $("bal").textContent = `${Number(formatEther(bal)).toFixed(6)} BNB`;
    }catch{}
  }catch(e){
    box.style.display="block";
    box.textContent = "Send error: " + (e.message||e);
    log($("netlog"), "Send error: " + (e.message||e));
  }
};

/* 初期：RPC設定だけ反映 */
RPC_URL = $("rpc").value.trim();
</script>
</body>
</html>
